---
title: "vacuum analyze all "
author: "XRZ"
date: '2023-03-15'
output: html_document
---

#Purpose:
This R markdown script looks for all tables in Truven schema starting with
  ccae%
  mdcr%
  hpm%
  
and vacuum analyzes them in order of n_liv_tup.

Most tables should vacuum analyze properly - ccaeo is the only big one
that times out so it goes last.


# SECTION 0: Loading required packages, making connections, the usual

## 0.1 Load packages
```{r package-loading, warning = FALSE}
# Package installs/loading 

if (!require("pacman")) install.packages("pacman")
pacman::p_load(RPostgres, DBI, odbc, keyring, openxlsx, tidyverse, beepr, tictoc, here)


```

## 0.2 Connect to TACC
```{r connect-to-tacc}
#PREREQUISITE: Set up your username/password in Keyring
# Instructions: replace indicated areas in code below with your username/password for TACC server
# Run it once, and delete from code - code will not need to be run more than once per user per computer
# Keyring will save your username/password to your OS credential store, and the service/user/password combo
# can be retrieved without hardcoding a password or requring user input.
# key_set_with_value(service = "Greenplum", 
#                   username = "-----------", #replace with your username
#                   password = "-----------") #replace with your password

# Function for connecting to TACC/Greenplum
# TACC kicks you out for inactivity so just call function before connections
connect_to_tacc <- function() {
  tac <- dbConnect(RPostgres::Postgres(),
  	 dbname = "uthealth",
  	 user = "xrzhang",
  	 password = key_get("Greenplum", "xrzhang"),
  	 host = "greenplum01.corral.tacc.utexas.edu",
  	 port = 5432)
}

```

# SECTION 1: Get list of tables to vacuum analyze

```{r}
#connect to tacc
tac = connect_to_tacc()

# get list of primary tables in truven (reference tables skipped)
# order by number of live tuples aka size - start from smallest
# and work way to biggest, that way if things fail then failure is at the end
table_names = dbGetQuery(tac, "select schemaname, relname from pg_stat_all_tables
  where schemaname = 'truven' and
  (relname like 'ccae%' or relname like 'mdcr%' or relname like 'hpm%')
  order by n_live_tup;")

```

# SECTION 2: Vacuum analyze them
```{r}

num_tables = nrow(table_names)

tac_vacuum_analyze = "vacuum analyze truven.@table;"

for (i in 1:num_tables){
  
  #Change current table
  current_table = table_names[i, 2]
  
  #modify SQL query
  tac_vacuum_analyze.mod = tac_vacuum_analyze %>%
    gsub("@table", current_table, .)
  
  #announce current table being analyzed
  print(paste0(tac_vacuum_analyze.mod, " Start time: ", Sys.time()))
  
  #refresh SQL db connection
  tac = connect_to_tacc()
  
  #begin timer
  tic(paste0("Vacuum analyze time for ", current_table, ":"))
  
  res <- dbSendQuery(tac, tac_vacuum_analyze.mod)
  
  # Keep the connection alive by sending a ping every 60 seconds
  while(!dbHasCompleted(res)) {
    dbSendQuery(tac, "SELECT 1")
    Sys.sleep(60)
  }
  
  # Disconnect from the database
  dbDisconnect(tac)
  
  #end timer
  toc()
}

# PROGRESS
# truven.ccaea - DONE
# truven.ccaed - DONE
# truven.ccaef - DONE
# truven.ccaei - DONE
# truven.ccaeo - SKIPPED, run o/n
# truven.ccaep - DONE
# ...everthing kept going until mdcrf, which is in progress

```


# SECTION 99: Close connections and clean-up

```{r close-connections, eval=FALSE}
# closes connections if they are open
if (dbIsValid(spc)) {dbDisconnect(spc)}

if (dbIsValid(tac)) {dbDisconnect(tac)} 

```

```{r clear-all-env, eval=FALSE}
# clears R environment
rm(list=ls())
```



