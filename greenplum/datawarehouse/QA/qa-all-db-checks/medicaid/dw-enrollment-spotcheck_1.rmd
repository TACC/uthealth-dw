---
title: "dw-enrollment-check"
author: "XRZ"
date: '2022-10-26'
output: html_document
---

#Purpose:
This R markdown script examines the accuracy of conversions from raw source tables to
data_warehouse tables


# SECTION 0: Loading required packages, making connections, the usual

## 0.1 Load packages
```{r package-loading, warning = FALSE}
# Package installs/loading 

if (!require("pacman")) install.packages("pacman")
pacman::p_load(DBI, odbc, rstudioapi, keyring, openxlsx, tidyverse, beepr, tictoc, here)

```

## 0.2 Connect to TACC
```{r connect-to-tacc}
#PREREQUISITE: Set up your username/password in Keyring
# Instructions: replace indicated areas in code below with your username/password for TACC server
# Run it once, and delete from code - code will not need to be run more than once per user per computer
# Keyring will save your username/password to your OS credential store, and the service/user/password combo
# can be retrieved without hardcoding a password or requring user input.
# key_set_with_value(service = "Greenplum", 
#                   username = "-----------", #replace with your username
#                   password = "-----------") #replace with your password


#Connect to Greenplum
tac <- dbConnect(odbc::odbc(),
	 dsn = "PostgreSQL30",
	 database = "uthealth",
	 UID = "xrzhang",
	 PWD = key_get("Greenplum", "xrzhang"),
	 host = "greenplum01.corral.tacc.utexas.edu",
	 port = 5432)
```

## 0.3 Connect to SPC
```{r connect-to-spcdedpwpvs1}
#PREREQUISITE: Set up connection to SPCDEDPWPVS1 in ODBC Data sources
#Make sure the default schema is correct! This one is set to medicaid

#Connect to SPCDEDPWPVS1
spc <- dbConnect(odbc::odbc(),
	 dsn = "medicaid")
```

## 0.4 Clear R environment (except for DB connections)
```{r clear-environment}
# clears R environment except for DB connections
rm(list=setdiff(ls(), c("tac", "spc")))
```

## 0.5 Set print to 25 rows
```{r}
knitr::opts_chunk$set(echo=TRUE, rows.print=25)

```

# SECTION 1: Define global variables

```{r}
#Define the starting and ending years for checking (4-digit year)
starting_year = 2012
ending_year = 2021

#Define how many rows to check per year
rows_to_check = '100000'

#convert to 2-digit year
starting_yr = starting_year - 2000
ending_yr = ending_year - 2000
```

# SECTION 2: Pull random rows from data_warehouse by year and upload to spc
```{r}
tac_sql = 'with b as (select race_cd_src, race_cd from reference_tables.ref_race
	where data_source = \'mdcd\' and race_cd_src is not null)

select a.data_source, a.member_id_src, a.year, a.total_enrolled_months, a.gender_cd,
b.race_cd_src, a.age_derived, a.dob_derived, a.zip5, a.plan_type, a.dual, a.htw
from dw_staging.member_enrollment_yearly a left join b
	on a.race_cd = b.race_cd
order by random()
limit @rows_to_check;'

tac_sql.mod = tac_sql %>% gsub('@rows_to_check', rows_to_check, .)
tac_selection = dbGetQuery(tac, tac_sql.mod)

dbGetQuery(spc, 'drop table if exists work.dbo.xz_dwqa_temp1;')
dbWriteTable(spc, SQL('work.dbo.xz_dwqa_temp1'), tac_selection)

```

# SECTION 3: Compare to cleaned variables

# SECTION 99: Close connections and clean-up

```{sql connection = spc, eval=FALSE}
drop table if exists work.dbo.xz_dwqa_temp1;

```

```{sql connection = tac, eval=FALSE}
drop table if exists dev.xz_dwqa_temp1;
drop table if exists dev.xz_dwqa_temp2;
drop table if exists dev.xz_dwqa_temp3;

```

```{r close-connections, eval=FALSE}
# closes connections if they are open
if (dbIsValid(spc)) {dbDisconnect(spc)}

if (dbIsValid(tac)) {dbDisconnect(tac)} 

```

```{r clear-all-env, eval=FALSE}
# clears R environment
rm(list=ls())
```



