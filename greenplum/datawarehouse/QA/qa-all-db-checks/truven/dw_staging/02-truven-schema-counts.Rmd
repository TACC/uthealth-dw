---
title: "dwqa-truven-schema-counts"
author: "XRZ"
date: '2023-01-09'
output: html_document
---

#Purpose:
This R markdown script counts unique msclmids and unique msclmid-enrolid
combinations in truven schema

# SECTION 0: Loading required packages, making connections, the usual

## 0.1 Load packages
```{r package-loading, warning = FALSE}
# Package installs/loading 

if (!require("pacman")) install.packages("pacman")
pacman::p_load(RPostgres, DBI, odbc, keyring, openxlsx, tidyverse, beepr, tictoc, here)

```

## 0.2 Connect to TACC
```{r connect-to-tacc}
#PREREQUISITE: Set up your username/password in Keyring
# Instructions: replace indicated areas in code below with your username/password for TACC server
# Run it once, and delete from code - code will not need to be run more than once per user per computer
# Keyring will save your username/password to your OS credential store, and the service/user/password combo
# can be retrieved without hardcoding a password or requring user input.
# key_set_with_value(service = "Greenplum", 
#                   username = "-----------", #replace with your username
#                   password = "-----------") #replace with your password

# Function for connecting to TACC/Greenplum
# TACC kicks you out for inactivity so just call function before connections
connect_to_tacc <- function() {
tac <- dbConnect(RPostgres::Postgres(),
	 dbname = "uthealth",
	 user = "xrzhang",
	 password = key_get("Greenplum", "xrzhang"),
	 host = "greenplum01.corral.tacc.utexas.edu",
	 port = 5432)
}

```

## 0.3 Clear R environment (except for DB connections)
```{r clear-environment}
# clears R environment except for DB connections
rm(list=setdiff(ls(), c("connect_to_tacc")))
```

## 0.5 Set misc R options
```{r}
knitr::opts_chunk$set(echo=TRUE, rows.print=25)
options("scipen"=100, "digits" = 4) #avoid scientific notation

#Make sure that the here() function is pointing to the parent folder for this file
here::i_am("02-truven-schema-counts.Rmd")

```
# SECTION 1: Get counts of rows and distinct ENROLIDs

## 1.1 Base SQL queries for modification
```{r}
#this is the list of tables to look in and count
list_of_tables = c("ccaes", "ccaeo", "mdcrs", "mdcro")

#sql query to count distinct msclmids
truv_sql1 = "select year, '@table'::text as table, count(distinct msclmid) as count from truven.@table
where enrolid is not null
group by year
order by year;"

#sql query to write unique combinations of enrolid || msclmid to a temp table
truv_sql2 = "create table dev.xz_dwqa_temp as
select year, '@table'::text as table_src, enrolid::text || msclmid::text as concat
from truven.@table
where enrolid is not null
distributed by (concat);"

#sql query to count unique enrolid || msclmids
truv_sql3 = "select year, table_src, count(distinct concat) from dev.xz_dwqa_temp
group by year, table_src
order by year;"

```


## 1.2 Get counts of distinct msclmids from truven schema
```{r}
tac = connect_to_tacc()

for (i in 1:4){
  
  current_table = list_of_tables[i]
  truv_sql1.mod = truv_sql1 %>% gsub("@table", current_table, .)
  
  tic(paste("Count distinct claim IDs from truven -", current_table))
  
  current_results = dbGetQuery(tac, truv_sql1.mod)
  
  if (i == 1) {
    truv_counts = current_results
  } else {
   truv_counts = rbind(truv_counts, current_results)
  }
  
  toc()

}
  
```

## 1.3: Count distinct enrolid-msclmid combinations
```{r}

tac = connect_to_tacc()

for (i in 1:4){
  
  current_table = list_of_tables[i]
  
  truv_sql2.mod = truv_sql2 %>% gsub("@table", current_table, .)
  
  tic(paste("Creating table of enrolid || msclmid from truven -", current_table))
  
  dbExecute(tac, "drop table if exists dev.xz_dwqa_temp;")
  dbExecute(tac, truv_sql2.mod)
  
  toc()
  
  tic(paste("Counting distinct enrolid || msclmid from truven -", current_table))
  
  current_results = dbGetQuery(tac, truv_sql3)
  
  toc()
  
  if (i == 1) {
    truv_concat_counts = current_results
  } else {
   truv_concat_counts = rbind(truv_concat_counts, current_results)
  }
  

}


```


# SECTION 2: Output to spreadsheet

## 2.1 Make tables
```{r}

# rearrange counts of distinct msclmids

for (i in 1:4){
  
  current_table = list_of_tables[i]
  newcolname = paste0("truv_", current_table)
  
  current = truv_counts %>%
    filter(table == current_table) %>%
    rename(!!newcolname := count) %>%
    select(-table)

    if (i==1){
      truv_clmid_tbl = current
    } else {
    truv_clmid_tbl = truv_clmid_tbl %>%
    left_join(current, by = "year")
    }
}

# rearrange counts of distinct enrolid || msclmid combos

for (i in 1:4){
  
  current_table = list_of_tables[i]
  newcolname = paste0("truv_concat_", current_table)
  
  current = truv_concat_counts %>%
    filter(table_src == current_table) %>%
    rename(!!newcolname := count) %>%
    select(-table_src)

    if (i==1){
      truv_concat_tbl = current
    } else {
    truv_concat_tbl = truv_concat_tbl %>%
    left_join(current, by = "year")
    }
}


```

## 2.2 Output to spreadsheet
```{r}

wb = createWorkbook()
dir = here("outputs")
path = here("outputs", "truven-raw-counts.xlsx")

addWorksheet(wb, sheetName="msclmids")
addWorksheet(wb, sheetName="enrolid || msclmid combos")

# sheet 1
current_sheet = 1; current_df = truv_clmid_tbl
writeData(wb, sheet = current_sheet,
          "Count of distinct claim IDs (msclmid) in Truven schema on TACC server",
          startCol=1, startRow=1)
writeData(wb, sheet = current_sheet, paste("Run time:", Sys.time()), startCol=1, startRow=2)
writeData(wb, sheet = current_sheet, current_df, startCol=1, startRow=4)
nextrow = nrow(current_df) + 6

setColWidths(wb, sheet = 1, cols=1:ncol(current_df)+1, widths="auto")
setColWidths(wb, sheet = 1, cols=1, widths=10)

# sheet 2
current_sheet = 2; current_df = truv_concat_tbl
writeData(wb, sheet = current_sheet,
          "Count of distinct enrolid-msclmid combinations in Truven schema on TACC server",
          startCol=1, startRow=1)
writeData(wb, sheet = current_sheet, paste("Run time:", Sys.time()), startCol=1, startRow=2)
writeData(wb, sheet = current_sheet, current_df, startCol=1, startRow=4)
nextrow = nrow(current_df) + 6

setColWidths(wb, sheet = 1, cols=1:ncol(current_df)+1, widths="auto")
setColWidths(wb, sheet = 1, cols=1, widths=10)

dir.create(file.path(dir), showWarnings = FALSE) #create directory if it does not exist
saveWorkbook(wb, file=path, overwrite=TRUE)

```




