---
title: "dw-claims-details-qa"
author: "XRZ"
date: '2022-10-24'
output: html_document
---

#Purpose:
This R markdown script examines the accuracy of conversions from raw source tables to
data_warehouse claims tables (Medicaid only)

It checks the counts of:
  Distinct ICNS/DERV_ENC
From:
  TACC server dw_staging schema
  TACC server medicaid schema
  SPC server medicaid schema (mostly)
  
Note that HTW is excluded from yearly counts bc FY 2018-19 are one table and there's
no easy way to split the two.

It's counted on its own special line.

# SECTION 0: Loading required packages, making connections, the usual

## 0.1 Load packages
```{r package-loading, warning = FALSE}
# Package installs/loading 

if (!require("pacman")) install.packages("pacman")
pacman::p_load(DBI, odbc, rstudioapi, keyring, openxlsx, tidyverse, beepr, tictoc)

```

## 0.2 Connect to TACC
```{r connect-to-tacc}
#PREREQUISITE: Set up your username/password in Keyring
# Instructions: replace indicated areas in code below with your username/password for TACC server
# Run it once, and delete from code - code will not need to be run more than once per user per computer
# Keyring will save your username/password to your OS credential store, and the service/user/password combo
# can be retrieved without hardcoding a password or requring user input.
# key_set_with_value(service = "Greenplum", 
#                   username = "-----------", #replace with your username
#                   password = "-----------") #replace with your password


#Connect to Greenplum
tac <- dbConnect(odbc::odbc(),
	 dsn = "PostgreSQL30",
	 database = "uthealth",
	 UID = "xrzhang",
	 PWD = key_get("Greenplum", "xrzhang"),
	 host = "greenplum01.corral.tacc.utexas.edu",
	 port = 5432)
```

## 0.3 Connect to SPC
```{r connect-to-spcdedpwpvs1}
#PREREQUISITE: Set up connection to SPCDEDPWPVS1 in ODBC Data sources
#Make sure the default schema is correct! This one is set to medicaid

#Connect to SPCDEDPWPVS1
spc <- dbConnect(odbc::odbc(),
	 dsn = "medicaid")
```

## 0.4 Clear R environment (except for DB connections)
```{r clear-environment}
# clears R environment except for DB connections
rm(list=setdiff(ls(), c("tac", "spc")))
```

## 0.5 Set print to 25 rows
```{r}
knitr::opts_chunk$set(echo=TRUE, rows.print=25)

```

# SECTION 1: Data_warehouse count


## 1.1 Headers
note that this is table is created by joining medicaid header table to proc table
using an inner join so the count should be different from header / proc counts alone

```{sql, connection = tac, output.var = distinct_ICN_det_dwstage}

--gets distinct ICNs from data_warehouse by year
select fiscal_year::text, count(distinct claim_id_src)
from dw_staging.claim_header
group by fiscal_year
order by fiscal_year; 

--gets distinct ICNs from data_warehouse (Total)
select 'all' as fiscal_year, count(distinct claim_id_src)
from dw_staging.claim_header;

```

## 1.2 Details
note that this is table is created by joining medicaid details table to proc table
using an inner join so the count should be different from details / proc counts alone

```{sql, connection = tac, output.var = distinct_ICN_detail_dwstage}

--gets distinct ICNs from data_warehouse by year
select fiscal_year::text, count(distinct claim_id_src)
from dw_staging.claim_detail
group by fiscal_year
order by fiscal_year; 

--gets distinct ICNs from data_warehouse (Total)
select 'all' as fiscal_year, count(distinct claim_id_src)
from dw_staging.claim_detail;

```


## 1.2 Get distinct ICN counts from details from TACC medicaid schema
```{sql, connection = tac, output.var = distinct_ICN_detail_TACCmcd}
--get distinct ICNs from medicaid schema (TACC) by year
select year_fy::text, count(distinct icn)
from (select year_fy, icn from medicaid.clm_detail
	union select year_fy, derv_enc from medicaid.enc_det) z
group by year_fy
order by year_fy;

--get distinct ICNs from medicaid schema (TACC, Total)
select 'all' as year_fy, count(*)
from (select icn from medicaid.clm_detail 
	union select derv_enc from medicaid.enc_det
	union select icn from medicaid.htw_clm_detail) z;

```

## 1.3 Get distinct ICN counts from procs from TACC medicaid schema
```{sql, connection = tac, output.var = distinct_ICN_proc_TACCmcd, eval=FALSE}
--get distinct ICNs from medicaid schema (TACC) by year
select year_fy::text, count(distinct icn)
from (select year_fy, icn from medicaid.clm_proc
	union select year_fy, derv_enc from medicaid.enc_proc
	union select year_fy, icn from medicaid.htw_clm_proc) z
group by year_fy
order by year_fy;

--get distinct ICNs from medicaid schema (TACC, Total)
select 'all' as year_fy, count(*)
from (select icn from medicaid.clm_proc 
	union select derv_enc from medicaid.enc_proc
	union select icn from medicaid.htw_clm_proc) z;

```

## 1.4 Get distinct ICN counts from details inner join procs from TACC medicaid schema
```{sql, connection = tac, output.var = distinct_ICN_innerjoin_TACCmcd}
--get distinct ICNs from medicaid schema (TACC) by year
select year_fy::text, count(distinct a.icn)
from (select year_fy, icn from medicaid.clm_detail
	union all select year_fy, derv_enc from medicaid.enc_det) a
	 inner join
	 (select year_fy, icn from medicaid.clm_proc
	union select year_fy, derv_enc from medicaid.enc_proc) b
	on a.icn = b.icn
group by a.year_fy
order by a.year_fy;

--get distinct ICNs from medicaid schema (TACC, Total)
select 'all' as year_fy, count(distinct a.icn)
from (select icn from medicaid.clm_detail
	union select derv_enc from medicaid.enc_det
	union select icn from medicaid.htw_clm_detail) a
	 inner join
	 (select icn from medicaid.clm_proc
	union select derv_enc from medicaid.enc_proc
	union select icn from medicaid.htw_clm_proc) b
	on a.icn = b.icn;

```

##1.41 Get distinct ICN counts from HTW (TACC)
```{sql, connection = tac, output.var = distinct_ICN_htw_TACCmcd}

--get distinct ICNs from htw_clms
select count(distinct icn)
from medicaid.htw_clm_detail;

select count(distinct icn)
from medicaid.htw_clm_proc;

select count(distinct a.icn)
from medicaid.htw_clm_detail a inner join medicaid.htw_clm_proc b
  on a.icn = b.icn;

```

## 1.5 Declare base SQL query for getting count of distinct ICNS each year from SPC server
The idea behind here is that joining and all that stuff is gonna be hella slow
Let's just count distinct by year (details, procs, and inner joins of the two) and compare to TACC

```{r}
#declare base queries to modify for getting the count of distinct ICNs each year

#counts it from details
sql4 = 'select count(*)
from (select icn from medicaid.dbo.clm_detail_@yr
	union select derv_enc from medicaid.dbo.enc_det_@yr) z;'

#counts it from procs
sql5 = 'select count(*)
from (select icn from medicaid.dbo.clm_proc_@yr
  union select derv_enc from medicaid.dbo.enc_proc_@yr) z;'

#counts the INNER JOIN of details and procs (center piece of venn diagram)
sql6 = 'select count(*)
from ((select a.icn from medicaid.dbo.clm_detail_@yr a
	inner join medicaid.dbo.clm_proc_@yr b on a.icn = b.icn)
	union
	(select c.derv_enc from medicaid.dbo.enc_det_@yr c
	inner join medicaid.dbo.enc_proc_@yr d on c.derv_enc = d.derv_enc)) z;'

```

##1.6 Initialize DF to store counts
```{r}
#initialize the dataframe
distinct_icns_by_year_spc = data.frame(matrix(data=NA, nrow=(21-13+3), ncol=3))

colnames = c("from_details", "from_procs", "inner_join")
colnames(distinct_icns_by_year_spc) = colnames

rownames = 2012:2021
rownames = c(rownames, "Total")
rownames(distinct_icns_by_year_spc) = rownames

```

## 1.7 Get distinct ICNs by year from SPC server
```{r}
#get the distinct ICNs by year from local SQL server

#2012 is special because there are no encounters
distinct_icns_by_year_spc[1,1] = dbGetQuery(spc, 'select count(distinct icn) from medicaid.dbo.clm_detail_12;')
distinct_icns_by_year_spc[1,2] = dbGetQuery(spc, 'select count(distinct icn) from medicaid.dbo.clm_proc_12;')
distinct_icns_by_year_spc[1,3] = dbGetQuery(spc, 'select count(distinct a.icn) from medicaid.dbo.clm_detail_12 a
                                            inner join medicaid.dbo.clm_proc_12 b on a.icn = b.icn;')

for (yr in 13:21){
  
  print(paste("Getting numbers for", yr))
  
  sql4.mod = sql4 %>% gsub(pattern = '@yr', replacement = yr)
  sql5.mod = sql5 %>% gsub(pattern = '@yr', replacement = yr)
  sql6.mod = sql6 %>% gsub(pattern = '@yr', replacement = yr)
  
  distinct_icns_by_year_spc[yr-11, 1] = dbGetQuery(spc, sql4.mod)
  distinct_icns_by_year_spc[yr-11, 2] = dbGetQuery(spc, sql5.mod)
  distinct_icns_by_year_spc[yr-11, 3] = dbGetQuery(spc, sql6.mod)
  
}


print.data.frame(distinct_icns_by_year_spc)

```

##1.71 Get distinct ICNs from HTW tables
```{sql, connection = spc, output.var = distinct_ICN_htw_spc}
select count (distinct icn) from medicaid.dbo.CLM_DETAIL_1819_HTW;

select count (distinct icn) from medicaid.dbo.CLM_PROC_1819_HTW;

select count (distinct a.icn)
from medicaid.dbo.CLM_DETAIL_1819_HTW a inner join
medicaid.dbo.CLM_PROC_1819_HTW b on a.icn = b.icn;
```

## 1.8 Get total distinct ICNs from details tables from SPC server
```{sql, connection = spc, output.var = total_distinct_ICN_detail_spc}

select count(*)
from (select icn from medicaid.dbo.clm_detail_12 union
	select icn from medicaid.dbo.clm_detail_13 union
	select icn from medicaid.dbo.clm_detail_14 union
	select icn from medicaid.dbo.clm_detail_15 union
	select icn from medicaid.dbo.clm_detail_16 union
	select icn from medicaid.dbo.clm_detail_17 union
	select icn from medicaid.dbo.clm_detail_18 union
	select icn from medicaid.dbo.clm_detail_19 union
	select icn from medicaid.dbo.CLM_detail_1819_HTW union
	select icn from medicaid.dbo.clm_detail_20 union
	select icn from medicaid.dbo.clm_detail_21 union
	select derv_enc from medicaid.dbo.enc_det_13 union
	select derv_enc from medicaid.dbo.enc_det_14 union
	select derv_enc from medicaid.dbo.enc_det_15 union
	select derv_enc from medicaid.dbo.enc_det_16 union
	select derv_enc from medicaid.dbo.enc_det_17 union
	select derv_enc from medicaid.dbo.enc_det_18 union
	select derv_enc from medicaid.dbo.enc_det_19 union
	select derv_enc from medicaid.dbo.enc_det_20 union
	select derv_enc from medicaid.dbo.enc_det_21) z;
	
```

## 1.9 Get total distinct ICNs from proc tables from SPC server
```{sql, connection = spc, output.var = total_distinct_ICN_proc_spc, eval=FALSE}

select count(*)
from (select icn from medicaid.dbo.clm_proc_12 union
	select icn from medicaid.dbo.clm_proc_13 union
	select icn from medicaid.dbo.clm_proc_14 union
	select icn from medicaid.dbo.clm_proc_15 union
	select icn from medicaid.dbo.clm_proc_16 union
	select icn from medicaid.dbo.clm_proc_17 union
	select icn from medicaid.dbo.clm_proc_18 union
	select icn from medicaid.dbo.clm_proc_19 union
	select icn from medicaid.dbo.clm_proc_20 union
	select icn from medicaid.dbo.clm_proc_21 union
	select icn from medicaid.dbo.CLM_PROC_1819_HTW union
	select derv_enc from medicaid.dbo.enc_proc_13 union
	select derv_enc from medicaid.dbo.enc_proc_14 union
	select derv_enc from medicaid.dbo.enc_proc_15 union
	select derv_enc from medicaid.dbo.enc_proc_16 union
	select derv_enc from medicaid.dbo.enc_proc_17 union
	select derv_enc from medicaid.dbo.enc_proc_18 union
	select derv_enc from medicaid.dbo.enc_proc_19 union
	select derv_enc from medicaid.dbo.enc_proc_20 union
	select derv_enc from medicaid.dbo.enc_proc_21) z;
	
```

#SECTION 2: Make summary tables

## 2.1 Table 1: Make the base table
```{r make-summary-table, rows.print=25}
#declare column names, row names
colnames= c("dw_detail", "mcd_detail_TACC", "mcd_proc_TACC",
            "mcd_joint_TACC", "mcd_detail_SPC", "mcd_proc_SPC",
            "mcd_joint_SPC")
rownames = as.character(2012:2021)
rownames = c(rownames, "HTW", "Total")

#subset distinct_ICN_detail_dwstage bc it has some weird years
distinct_ICN_detail_dwstage2 = distinct_ICN_detail_dwstage %>%
  filter((fiscal_year > 2011 & fiscal_year < 2022) | fiscal_year == 97)

#cbind in numbers from tacc and convert to dataframe
count_of_distinct_claims_summary = data.frame(cbind(
  distinct_ICN_detail_dwstage2$count,
  distinct_ICN_detail_TACCmcd$count,
  distinct_ICN_proc_TACCmcd$count,
  distinct_ICN_innerjoin_TACCmcd$count))
  
#cbind in SPC numbers
count_of_distinct_claims_summary = cbind(
  count_of_distinct_claims_summary,
  distinct_icns_by_year_spc)

#add in totals from SPC
count_of_distinct_claims_summary[11,5] = total_distinct_ICN_detail_spc[1,1]
count_of_distinct_claims_summary[11,6] = total_distinct_ICN_proc_spc[1,1]

#Fix to add in HTW numbers
emptyrow = data.frame(matrix(data=NA, nrow=(1), ncol=7))
colnames(emptyrow) = colnames
colnames(count_of_distinct_claims_summary) = colnames

count_of_distinct_claims_summary = rbind(count_of_distinct_claims_summary[1:10,], emptyrow, count_of_distinct_claims_summary[11,])

#insert HTW numbers from TACC
count_of_distinct_claims_summary[11,2] = distinct_ICN_htw_TACCmcd[1,1]
count_of_distinct_claims_summary[11,3] = distinct_ICN_htw_TACCmcd[2,1]
count_of_distinct_claims_summary[11,4] = distinct_ICN_htw_TACCmcd[3,1]

#insert HTW numbers from SPC
count_of_distinct_claims_summary[11,5] = distinct_ICN_htw_spc[1,1]
count_of_distinct_claims_summary[11,6] = distinct_ICN_htw_spc[2,1]
count_of_distinct_claims_summary[11,7] = distinct_ICN_htw_spc[3,1]

#assign row names
row.names(count_of_distinct_claims_summary) = rownames

#print the table
#note that the medicaid joined SPC Total is intentionally blank
#processing time is too long, better to just skip.
count_of_distinct_claims_summary

```
## 2.2 Table 2: Does TACC match SPC?
```{r, rows.print=15}

TACCvSPC = count_of_distinct_claims_summary %>%
  mutate (detail_diff = mcd_detail_SPC - mcd_detail_TACC ) %>%
  mutate (proc_diff = mcd_proc_SPC - mcd_proc_TACC ) %>%
  mutate (joint_diff = mcd_joint_SPC - mcd_joint_TACC) %>%
  select (2, 5, 8, 3, 6, 9, 4, 7, 10 )
```
## 2.3 Table 3: Does DW match medicaid schema on TACC?
```{r, rows.print=15}

DWvMCD = count_of_distinct_claims_summary %>%
  mutate (diff = mcd_joint_TACC - dw_detail ) %>%
  select (1, 4, 8)

```
## 2.4 Table 4: Mismatches within each year
```{r, rows.print=15}

yearly_mismatch = count_of_distinct_claims_summary %>%
  mutate (TACCdetail_excess =  mcd_detail_TACC - mcd_joint_TACC ) %>%
  mutate (TACCproc_excess =  mcd_proc_TACC - mcd_joint_TACC ) %>%
  mutate (SPCdetailer_excess =  mcd_detail_SPC - mcd_joint_SPC ) %>%
  mutate (SPCproc_excess =  mcd_proc_SPC - mcd_joint_SPC ) %>%
  select (2, 3, 4, 8, 9, 5, 6, 7, 10, 11)

```


#SECTION 3: Output it to a spreadsheet
```{r}
#make table legends so we know what the columns are
legend_colnames = c("Column Name", "Description")

column_name1 = colnames(count_of_distinct_claims_summary)
description1 <- c("Count of distinct claims in dw_staging.claim_detail",
                  "Count of distinct claims in medicaid.clm_detail and medicaid.enc_det (TACC)",
                  "Count of distinct claims in medicaid.clm_proc and medicaid.enc_proc (TACC)",
                  "Count of distinct claims in details inner join to procs (TACC)",
                  "Count of distinct claims from raw data in SPC server (details)",
                  "Count of distinct claims from raw data in SPC server (procs)",
                  "Count of distinct claims from raw data in SPC server (details inner join to procs by year)")
table1_legend <- data.frame(column_name1, description1)
colnames(table1_legend) = legend_colnames

column_name2 = colnames(TACCvSPC)
description2 <- c("Count of distinct claims in medicaid.clm_detail and medicaid.enc_det (TACC)",
                  "Count of distinct claims from raw data in SPC server (details)",
                  "Difference of distinct claims between TACC medicaid schema and SPC raw data (details)",
                  "Count of distinct claims in medicaid.clm_proc and medicaid.enc_proc (TACC)",
                  "Count of distinct claims from raw data in SPC server (procs)",
                  "Difference of distinct claims between TACC medicaid schema and SPC raw data (procs)",
                  "Count of distinct claims in details inner join to procs (TACC)",
                  "Count of distinct claims from raw data in SPC server (details inner join to procs by year",
                  "Difference of distinct claims between TACC medicaid schema and SPC raw data (inner joins)")
table2_legend <- data.frame(column_name2, description2)
colnames(table2_legend) = legend_colnames

column_name3 = colnames(DWvMCD)
description3 <- c("Count of distinct claims in dw_staging.claim_detail",
                  "Count of distinct claims in medicaid.clm_detail and medicaid.enc_det (TACC)",
                  "Difference between dw_staging and medicaid schema (TACC)")
table3_legend <- data.frame(column_name3, description3)
colnames(table3_legend) = legend_colnames

column_name4 = colnames(yearly_mismatch)
description4 <- c("Count of distinct claims in medicaid.clm_detail and medicaid.enc_det (TACC)",
                  "Count of distinct claims in medicaid.clm_proc and medicaid.enc_proc (TACC)",
                  "Count of distinct claims in details inner join to procs (TACC)",
                  "Count of distinct claims in details that are not in the joined table (TACC)",
                  "Count of distinct claims in procs that are not in the joined table (TACC)",
                  "Count of distinct claims from raw data in SPC server (details)",
                  "Count of distinct claims from raw data in SPC server (procs)",
                  "Count of distinct claims from raw data in SPC server (details inner join to procs by year)",
                  "Count of distinct claims in details that are not in the joined table (SPC)",
                  "Count of distinct claims in procs that are not in the joined table (SPC)")
table4_legend <- data.frame(column_name4, description4)
colnames(table4_legend) = legend_colnames

```

```{r}
filename = "dw-claims-details-qa.xlsx"
directory = "H:/GitHub/uthealth-dw/greenplum/datawarehouse/QA/qa-all-db-checks/dw-enrollment-qa/Outputs/"

wb = createWorkbook()

addWorksheet(wb, sheetName = "Raw counts")
addWorksheet(wb, sheetName = "TACC vs SPC")
addWorksheet(wb, sheetName = "DW vs MCD")
addWorksheet(wb, sheetName = "Yearly mismatches")

writeData(wb, sheet = 1, x = "Raw Counts of Distinct Claims", startCol = 1, startRow = 1)
writeData(wb, sheet = 1, x = paste("Run date:", Sys.Date()), startCol = 1, startRow = 2)
writeData(wb, sheet = 1, x = count_of_distinct_claims_summary, rowNames = TRUE, startCol=1, startRow=4)
writeData(wb, sheet = 1, x = table1_legend, startCol=1, startRow=nrow(count_of_distinct_claims_summary)+6)

writeData(wb, sheet = 2, x = "Comparing counts of distinct claims across servers", startCol = 1, startRow = 1)
writeData(wb, sheet = 2, x = paste("Run date:", Sys.Date()), startCol = 1, startRow = 2)
writeData(wb, sheet = 2, x = TACCvSPC, rowNames = TRUE, startCol=1, startRow=4)
writeData(wb, sheet = 2, x = table2_legend, startCol=1, startRow=nrow(TACCvSPC)+6)

writeData(wb, sheet = 3, x = "Comparing counts of distinct claims between data_warehouse and TACC medicaid schema", startCol = 1, startRow = 1)
writeData(wb, sheet = 3, x = paste("Run date:", Sys.Date()), startCol = 1, startRow = 2)
writeData(wb, sheet = 3, x = DWvMCD, rowNames = TRUE, startCol=1, startRow=4)
writeData(wb, sheet = 3, x = table3_legend, startCol=1, startRow=nrow(DWvMCD)+6)

writeData(wb, sheet = 4, x = "Comparing counts of distinct claims across servers", startCol = 1, startRow = 1)
writeData(wb, sheet = 4, x = paste("Run date:", Sys.Date()), startCol = 1, startRow = 2)
writeData(wb, sheet = 4, x = yearly_mismatch, rowNames = TRUE, startCol=1, startRow=4)
writeData(wb, sheet = 4, x = table4_legend, startCol=1, startRow=nrow(yearly_mismatch)+6)

saveWorkbook(wb, file=paste0(directory, filename), overwrite=TRUE)

```


#SECTION 99: Delete temp tables, Close connections, clear R environment

```{sql, connection=spc, eval = FALSE}
drop table if exists work.dbo.xz_temp3_clm;

drop table if exists work.dbo.xz_temp3_enc;

```

```{r close-connections, eval = FALSE}
# closes connections if they are open
if (dbIsValid(spc)) {dbDisconnect(spc)}

if (dbIsValid(tac)) {dbDisconnect(tac)} 

```

```{r clear-all-env, eval = FALSE}
# clears R environment
rm(list=ls())
```
